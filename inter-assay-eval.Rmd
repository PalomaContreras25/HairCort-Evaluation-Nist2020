---
title: "Analysis - raw vals Inter-assays"
author: "Paloma"
date: "`r Sys.Date()`"
output: workflowr::wflow_html
editor_options: 
  chunk_output_type: console
---
# Introduction

```{r}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(ggplot2)
```


```{r}
# Loading data
data_path <- "./data/"
cat("Input:")
print(file.path(data_path, "inter-assay-eval.csv")) 
data <- read.csv(file.path(data_path, "inter-assay-eval.csv"))

summary(data)

```


```{r}
library(tidyverse)
library(janitor)
library(patchwork)
library(ggpubr)
library(scales)
library(ggrepel)

df_raw <- readr::read_csv(file.path(data_path, "inter-assay-eval.csv"), show_col_types = FALSE) %>% clean_names()
df_raw <- df_raw %>%
  filter(problematic != "error", plate != 6)
  
```

```{r echo=TRUE}
# Keep only needed cols; warn if missing
needed <- c("normalized_data","reconst_buffer","weight","plate","sample_in_well", "sample_id")
missing <- setdiff(needed, names(df_raw))
if (length(missing)) {
  stop(paste("Missing columns:", paste(missing, collapse=", ")))
}


df <- df_raw %>%
  dplyr::select(all_of(needed)) %>%
  # Coerce types carefully
  mutate(
    plate = as.factor(plate),
    reconst_buffer = as.factor(reconst_buffer),
    # try to parse numeric if read as character
    weight = suppressWarnings(as.numeric(weight)),
    sample_in_well_num = suppressWarnings(as.numeric(sample_in_well)),
    # keep a categorical version too
    sample_in_well_fct = ifelse(is.na(sample_in_well_num),
                                as.factor(sample_in_well),
                                cut(sample_in_well_num, breaks = pretty(sample_in_well_num, n = 6), include.lowest = TRUE))
  ) %>%
  filter(!is.na(normalized_data))

# Quick overview table
overview <- df %>%
  summarize(
    n_plate = n_distinct(plate),
    n_buffers = n_distinct(reconst_buffer),
    wt_min = min(weight, na.rm=TRUE),
    wt_med = median(weight, na.rm=TRUE),
    wt_max = max(weight, na.rm=TRUE)
  )
print(overview)

# ===== Plot 1: normalized_data vs weight (color = reconst_buffer, facets by plate) =====
p1 <- ggplot(df, aes(x = weight, y = normalized_data, color = plate, shape = reconst_buffer)) +
  geom_point(alpha = 0.6, size = 3, na.rm = TRUE) +
  #geom_smooth(method = "loess", se = FALSE, linewidth = 0.9, na.rm = TRUE) +
 # facet_wrap(~ reconst_buffer, scales = "free_x") +
  labs(
    title = "Binding % vs weight",
    x = "Weight (mg)",
    y = "Binding %",
    color = "Plate"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom") +
  scale_x_continuous(limits = c(8, 21)) +
  geom_text_repel(
    data = subset(df, sample_id == "Pool"),
    aes(label = sample_id),   # or use a different column with sample names
    color = "gold2",
    size = 3
  )
p1

```

```{r}
# CV across all plates, only pool samples
mean_pool <- df %>%
  filter(sample_id == "Pool") %>%
  summarize(
    mean_pool = mean(normalized_data, na.rm = TRUE),
    sd_pool   = sd(normalized_data, na.rm = TRUE),
    cv_percent = (sd_pool / mean_pool) * 100
  )


p_pool <- df %>%
  filter(sample_id == "Pool") %>%
  ggplot(aes(x = plate, y = normalized_data)) +
  geom_boxplot(width = 0.3, alpha = 0.2, color = "gray") +
  geom_jitter(alpha = 1, size = 3, width = 0.3) +
  labs(
    title = "Binding % for Pool Samples",
    x = "Plate number",
    y = "Binding %"
  ) +
  theme_minimal(base_size = 12) +
  ylim(20, 80)


p_pool


pool <- df %>%
  filter(sample_id == "Pool") 

cv_pool <- stats::sd(pool$normalized_data) / mean(pool$normalized_data) *100
cv_pool

```




```{r}

```



