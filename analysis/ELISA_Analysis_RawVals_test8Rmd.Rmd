---
title: "Analysis - raw vals test8"
author: "Paloma"
date: "`r Sys.Date()`"
output: workflowr::wflow_html

---
# Introduction

```{r}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r libraries, echo = FALSE, warning = FALSE, message=FALSE}
# Install libraries
library(knitr)
library(RColorBrewer)
library(stats)
library(coefplot)
library(arm)
library(bbmle)
library(plyr)
library(ggpmisc)
library(ggplot2)
library(dplyr)
```

```{r loading}

# Loading data
data_path <- "./data/Test8"
cat("Input:")
print(file.path(data_path, "Data_QC_flagged.csv"))  # Check the full path
print(file.path(data_path, "Data_cort_values.csv"))  # 
#qc <- read.csv(file.path(data_path, "Data_QC_flagged.csv"))
std <- read.csv(file.path(data_path, "Standard_data_test8.csv"))
data <- read.csv(file.path(data_path, "Data_cort_values.csv"))

# remove NSB
#data <- data[!(data$Sample == "NSB"),]

#Inclusion of standard readings in plot

std$Spike <- NA
std$Buffer_nl <- NA
std$Category <- "Std-A"
std$Weight_mg <- NA
std$Sample<-gsub("Standard", "stA", std$Sample)
std <- dplyr::rename(std, Conc_pg.ml = Backfit)

data_std <- join(data, std,  type = "full") 
#data_std_qc <- join(data_std, qc, type = "full")

```

# Summary of results 
## Binding Percentage by groups

```{r groups.binding.perc, fig.width=7, fig.height=6}
# Scatter plot  observed binding % 

ggplot(data_std, aes(x = Category, 
                 y = Binding.Perc, color = Category)) +
  geom_smooth(method = "lm", se = FALSE, linewidth = 0.2, linetype = 2, alpha = 0.2, aes(group = Category)) +
  geom_point(size = 2) +
  geom_text(aes(label = Sample), size = 3, vjust = -1, hjust = 0.5, color = "gray30") +
  geom_hline(yintercept = 80, linetype = "dashed", 
             color = "gray", linewidth = 1) +  
  geom_hline(yintercept = 20, linetype = "dashed", 
             color = "gray", linewidth = 1) +  # Add horizontal line 
 # stat_poly_eq(aes(x = Sample_num, label = paste(..rr.label.., sep = "~")),
  #             formula = y ~ x, parse = TRUE, size = 2.5) +
 # geom_abline(slope = 14.72, intercept = -3.6, linetype = "dashed", color = "lightblue") + # ideal line
  labs(title = "Observed binding %",
       subtitle = "",
       x = "Group", y = "% Binding") +
  scale_y_continuous(n.breaks = 10) + 
  theme_minimal() 

```



```{r groups.binding.perc.cort, fig.width=7, fig.height=6}
# Scatter plot observed binding % and cort vals

ggplot(data_std, aes(x = Ave_Conc_pg.ml, 
                 y = Binding.Perc, color = Category)) +
  geom_smooth(method = "lm", se = FALSE, linewidth = 0.2, linetype = 2, alpha = 0.2, aes(group = Category)) +
  geom_point(size = 2) +
  geom_text(aes(label = Sample), size = 3, vjust = -1, hjust = 0.5, color = "gray30") +
  geom_hline(yintercept = 80, linetype = "dashed", 
             color = "gray", linewidth = 1) +  
  geom_hline(yintercept = 20, linetype = "dashed", 
             color = "gray", linewidth = 1) +   
  labs(title = "Observed binding % and cortisol values",
       subtitle = "cort vals not controlling for differences in weight or reconstitution volume",
       x = "Concentration (pg/mg)", y = "Binding Percentage") +
  scale_y_continuous(n.breaks = 10) + 
  theme_minimal() 

```

```{r groups.binding.perc.cort.zoom.in, fig.width=7, fig.height=6}
# Scatter plot observed binding % and cort vals

ggplot(data_std, aes(x = Ave_Conc_pg.ml, 
                 y = Binding.Perc, color = Category)) +
  geom_point(size = 2) +
  xlim(0,8500) +
  geom_text(aes(label = Sample), size = 3, vjust = -1, hjust = 0.5, color = "gray30") +
  geom_smooth( method = "gam", formula = y ~ s(log(x)), se = FALSE, linewidth = 0.5, alpha = 0.1) +
  geom_hline(yintercept = 80, linetype = "dashed", 
             color = "gray", linewidth = 1) +  
  geom_hline(yintercept = 20, linetype = "dashed", 
             color = "gray", linewidth = 1) +   
  labs(title = "Observed binding % and cortisol values, excluding outliers",
       subtitle = "cort vals not controlling for differences in weight or reconstitution volume",
       x = "Concentration (pg/mg)", y = "Binding Percentage") +
  scale_y_continuous(n.breaks = 10) + 
  theme_minimal() 

```

## Binding by sample

```{r expA.binding.perc}
# Scatter plot of Experiment A, observed binding % by category
a <- filter(data_std, Category == "Std-A" | Category == "Std-B" | Category == "P10" | Category == "P20"| Category == "T20", !is.na(Binding.Perc))
a$Sample_num <- 1:length(a$Sample)


ggplot(a, aes(x = Sample_num, 
                 y = Binding.Perc, color = Category)) +
  geom_smooth(method = "lm", se = TRUE, linewidth = 0.5, alpha = 0.2) +
  geom_point(size = 2) +
  geom_text(aes(label = Sample), size = 3, vjust = -1, hjust = 0.5, color = "gray30") +
  geom_hline(yintercept = 80, linetype = "dashed", 
             color = "gray", linewidth = 1) +  
  geom_hline(yintercept = 20, linetype = "dashed", 
             color = "gray", linewidth = 1) +  # Add horizontal line 
#  stat_poly_eq(aes(x = Sample_num, label = paste(..rr.label.., sep = "~~~")),
 #              formula = y ~ x, parse = TRUE, size = 4) +
 # geom_abline(slope = 14.72, intercept = -3.6, linetype = "dashed", color = "lightblue") + # ideal line
  labs(title = "Observed binding %",
       subtitle = "",
       x = "Sample", y = "Binding Percentage") +
  scale_y_continuous(n.breaks = 10) + 
  theme_minimal() 

```


# Pending

```{r expABCD.conc.expect.vs.observed}
a <- filter(data_std, Category == "Sta" | Category == "Std-B" | Category == "P10" | Category == "P20", !is.na(Binding.Perc))
a$Sample_num <- 1:length(a$Sample)

a$Exp <- NA

ggplot(a, aes(x = Exp, 
                 y = (Ave_Conc_pg.ml), color = Category)) +
  geom_smooth(method = "lm", se = FALSE, linewidth = 0.5, alpha = 0.06) +
  geom_point(size = 2) +
  geom_text(aes(label = Sample), size = 3, vjust = -1, hjust = 0.5, color = "gray50") +
  stat_poly_eq(aes(x = Exp, label = paste(..rr.label.., sep = "~~~")),
               formula = y ~ x, parse = TRUE, size = 4) +
   geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "gray") +
  labs(title = "All serial dilutions: expected vs observed cortisol concentrations",
       subtitle = "Complete dataset",
       x = "Expected vals (pg/mL)", y = "Observed vals (pg/mL)") +
  theme_bw() 

``` 




