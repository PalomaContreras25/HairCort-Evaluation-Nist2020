---
title: "Cortisol Concentration Values, Test4"
author: "Paloma Contreras"
date: "`r Sys.Date()`"
output: workflowr::wflow_html
---

# Summary

**Cortisol value calculations** (includes bad quality samples, n = 41)


|                        | Min. | 1st Qu. | Median | Mean | 3rd Qu. | Max. | NA's |
|------------------------|------|---------|---------|---------|---------|-------|------|
|**A) Standard Method (mult. by sample dilution)**| 17.13 | 29.01  | 32.27  | 35.28 | 39.47 | 82.94 |    4  |
|**B) Spike-Corrected Method (Nist 2020)**| **-45.870** | -35.833 | -5.960 | -3.488 |  23.109 | **50.963**  |  4 |
|**C) Spike-Corrected (Sam's Method)**| **7.472** | 18.533    |24.559|  27.009| 31.196 |**80.804**    |   4 |


**Cortisol value calculations** (removed bad quality samples)

|                        | Min.   | 1st Qu. |  Median |  Mean   | 3rd Qu. | Max.   |  
|------------------------|--------|---------|---------|---------|---------|--------|
|**A) Standard Method (mult. by sample dilution)**| 18.27 | 29.27  | 31.54  | 34.13 | 37.73 | 69.17 |
|**B) Spike-Corrected Method (Nist 2020)**|**-39.371** | -34.855 | -20.577 | -14.325 |  -6.825 | **40.400** |
|**C) Spike-Corrected (Sam's Method)**| ** 11.80** | 18.45    |24.09|  24.05| 30.32 | **40.40**    |

**Results:**  

- Intra-assay CV: 14.5% 

- Intra-assay CV after removing low quality samples: 10%

- Inter-assay CV: **21%** (Bindings for 20mg sample diluted in 250 uL, no spike: 64.8% and 48% in test3 and test4, respectively)


**Conclusions**: 



**Concerns:**
Overall quality of the plate is not great, but serial dilusions show clear parallelism and standards have values within the expected

## Explanation of each variable used in calculations

- Ave_Conc_pg/ml: average ELISA reading per sample in pg/mL

- Weight_mg: hair weight in mg

- Buffer_nl: assay buffer volume in nL → we convert to mL

- Spike: binary indicator (1 = spiked sample)

- SpikeVol_uL: volume of spike added in µL

- Dilution: dilution factor (already present)

- Vol_in_well.tube_uL: total volume in well/tube in µL (for spike correction)

- std: standard reading value

- extraction: methanol volume ratio = vol added / vol recovered (e.g. 1/0.75 ml)


# Cortisol concentration calculations

```{r Loading files, echo = FALSE, message=FALSE}
#path:
data_path = "./data/Test4"
library(knitr)
library(ggplot2)
library(broom)
library(paletteer)
library(dplyr)
df <- read.csv(file.path(data_path,"Data_QC_flagged.csv"))
```

```{r}
#practice
Ave_Conc_pg.ml <- 4617 
Spike_contribution <- 0
Weight_mg <- 50
Extraction_ratio <- 1.3/1
Buffer_ml <- 0.25

((Ave_Conc_pg.ml - Spike_contribution) /  # (A - spike) 
       Weight_mg) *                                    # / B *
     Extraction_ratio *                               # C / D *
      Buffer_ml     
# 31.19476

Ave_Conc_pg.ml / Weight_mg *  Extraction_ratio *  Buffer_ml   
# 31.19476

```
((A/B) * (C/D) * E * 10,000 * SLd) = F 

Parameters and unit transformations: 
```{r parameters}
# Volume of methanol used for cortisol extraction varies, so it is included in file
# as Extraction_ratio (vol added / vol recovered) in mL

# Reading of spike standard and conversion to ug/dl
std <- (3191 + 3228) / 2 # test 4 backfit
std.r <- std / 10000 # std in ul/dl

# Creating variables in indicated units
df$Buffer_ml <- c(df$Buffer_nl/1000) # dilution (buffer)
df$Ave_Conc_ug.dl <- c(df$Ave_Conc_pg.ml/10000) # Transform to μg/dl from assay output
```
Identify and flag bad quality samples
```{r filter, include=TRUE, message=FALSE, echo = FALSE}

# remove outlier
#df<- df[(df$Sample != "TP3A"),]
# label samples by quality

df$Failed_samples[is.na(df$Failed_samples)] <- "OK"
table(df$Failed_samples)
df$Failed_samples[df$Failed_samples == "ABOVE 80% binding"] <- "Out of curve"
df$Failed_samples[df$Failed_samples == "HIGH CV;ABOVE 80% binding"] <- "High CV & Out of curve"
df$Failed_samples[df$Failed_samples == "HIGH CV;UNDER 20% binding"] <- "High CV & Out of curve"
df$Failed_samples[df$Failed_samples == "HIGH CV"] <- "High CV"
df$Failed_samples[df$Failed_samples == "UNDER 20% binding"] <- "Out of curve"

df$Failed_samples <- factor(
  df$Failed_samples,
  levels = c(
    "OK",
    "Out of curve",
    "High CV",
    "High CV & Out of curve"
  )
)

# remove unnecessary information 
data <- df %>%
    dplyr::select(Wells, Sample, Category, Binding.Perc, Ave_Conc_ug.dl, Ave_Conc_pg.ml, Weight_mg, Buffer_ml, Spike, SpikeVol_ul, Dilution_sample, Dilution_spike, Extraction_ratio, Vol_in_well.tube_ul, Failed_samples) 

data <- data[!is.na(data$Binding.Perc), ] # remove duplicates
```

## (A) Standard Calculation

Formula: 

((A/B) * (C/D) * E * 10,000) = F 

- A = μg/dl from assay output;
- B = weight (in mg) of hair subjected to extraction;
- C = vol. (in ml) of methanol added to the powdered hair;
- D = vol. (in ml) of methanol recovered from the extract and subsequently dried down;
- E = vol. (in ml) of assay buffer used to reconstitute the dried extract;
- F = final value of hair CORT Concentration in pg/mg



```{r A}
##################################
##### Calculate final values #####
##################################

data$Final_pg.mg_A <- c(
    ((data$Ave_Conc_ug.dl) / data$Weight_mg) *             # A/B *
      data$Extraction_ratio *                              # C/D  *     
      data$Buffer_ml * 10000)       # E * 10000 

```

```{r echo=FALSE}
data <- data[order(data$Sample),]
write.csv(data, file.path(data_path, "Data_cort_values_methodA.csv"), row.names = F)

# summary for all samples
data <- data %>%
  filter(!Sample %in% c("B0", "BE", "NSB", "POOL")) 

cat("Summary of all samples (n =", nrow(data), "):")
summary(data$Final_pg.mg_A)

temp <- data %>% 
  filter(Failed_samples == 
           "OK")
cat("Summary for good quality samples only (n =", nrow(temp), "):")

summary(temp$Final_pg.mg_A)
```

## (B) Accounting for Spike

We followed the procedure described in **Nist et al. 2020**:

"Thus, after pipetting 25μL of standards and samples into the appropriate wells of the 96-well assay plate, we added 25μL of the 0.333ug/dL standard to all samples,
resulting in a 1:2 dilution of samples. The remainder of the manufacturer’s protocol was
unchanged. We analyzed the assay plate in a Powerwave plate reader (BioTek, Winooski,
VT) at 450nm and subtracted background values from all assay wells. In the calculations, we
subtracted the 0.333ug/dL standard reading from the sample readings. Samples that resulted
in a **negative number were considered nondetectable**. We converted cortisol levels from
ug/dL, as measured by the assay, to pg/mg—based on the mass of hair collected and
analyzed using the following formula:

A/B * C/D * E * 10,000 * 2 = F

where 

- A = μg/dl from assay output; 
- B = weight (in mg) of collected hair; 
- C = vol. (in ml) of methanol added to the powdered hair; 
- D = vol. (in ml) of methanol recovered from the extract and subsequently dried down; 
- E = vol. (in ml) of assay buffer used to reconstitute the dried extract; 10,000 accounts for changes in metrics; 2 accounts for the dilution factor after addition of the spike; and 
- F = final value of hair cortisol concentration in pg/mg"
- **SPd** = sample dilution factor (if serially diluted)

```{r B-calc}
##################################
##### Calculate final values #####
##################################

# spike is already divided by 10000 (unit is ug/dL)
data$Final_pg.mg_B <- 
  ifelse(
    data$Spike == 1,                                         ## Only spiked samples
      ((data$Ave_Conc_ug.dl - (std.r)) /                     # (A-spike) 
        data$Weight_mg)                                      # / B
        * data$Extraction_ratio *                            # C / D
        data$Buffer_ml * 10000 * 2,   # E * 10000 * 2
        data$Final_pg.mg_A  
    )

```

```{r echo = FALSE}

write.csv(data, file.path(data_path, "Data_cort_values_methodB.csv"), row.names = F)

# summary for all samples
data <- data %>%
  filter(!Sample %in% c("B0", "BE", "NSB", "POOL")) 

cat("Summary all samples:")
summary(data$Final_pg.mg_B)

# summary for good quality samples only
temp <- data %>% 
  filter(Failed_samples == 
           "OK")
cat("Summary good quality samples only:")
summary(temp$Final_pg.mg_B)
```

## (C) Sam's calculation

Simplifies unnecessary unit transformations and accounts for spike considering dilution of both sample and the spike

- Step 1: Calculate contribution of the spike
- Step 2: Substract spike from plate reading values and calculate final values accounting for dilution of the sample, weight, and reconstitution

**Step 1**: Calculate contribution of spike

X * Y / Z / SPd = SP

- SP = final value of spike contribution in pg/mL
- X = volume of spike added (mL)
- Y = concentration of the spike added (pg/mL)
- SPd = if serially diluted, dilution factor for the spike (i.e: 1, 2, 4, 8, etc.)
- Z = total volume (mL) in the well or tube, if spike is added before loading the plate (sample + spike)

```{r C calc}
# Transforming units
data$SpikeVol_ml <- data$SpikeVol_ul/1000                 # X to mL
data$Vol_in_well.tube_ml <- data$Vol_in_well.tube_ul/1000 # Z to mL
  
# Calculate spike contribution to each sample
      ##  ( Spike vol. x Spike Conc.)
      ##   ------------------------  / dilution = Spike contribution
      ##        Total vol. 
  
# Calculate cort contribution of spike to each sample
data$Spike_contribution <- ((data$SpikeVol_ml * std  /     # X * Y
                            data$Vol_in_well.tube_ml) /  # Z / 
                              data$Dilution_spike)       # SP
```

```{r echo = FALSE}
cat("The reading for standard 1 in this plate is", std)
cat("The total contribution of the Spike to each sample is can be any of the following numbers (in pg/ml)")
unique(data$Spike_contribution)

```
**Step 2 **: Substract spike and calculate final values

((A - **SP**)/B) * (C/D) * E * **SLd**  = F

- A = pg/ml from assay output;
- *SP* = spike contribution (in pg/ml) 
- B = weight (in mg) of hair subjected to extraction;
- C = vol. (in ml) of methanol added to the powdered hair;
- D = vol. (in ml) of methanol recovered from the extract and subsequently dried down;
- E = vol. (in ml) of assay buffer used to reconstitute the dried extract;
- F = final value of hair CORT Concentration in pg/mg.


```{r}
##################################
##### Calculate final values #####
##################################

data$Final_pg.mg_C <- 
     (((data$Ave_Conc_pg.ml - data$Spike_contribution)) /  # (A - spike) 
      data$Weight_mg) *                                    # / B *
     data$Extraction_ratio *                               # C / D *
      data$Buffer_ml                                       # E 
head(data)
```

   


```{r echo = FALSE}
write.csv(data, file.path(data_path, "Data_cort_values_methodC.csv"), row.names = F)
write.csv(data, file.path(data_path, "Data_cort_values_method_ALL.csv"), row.names = F)
# summary for all samples
data <- data %>%
  filter(!Sample %in% c("B0", "BE", "NSB", "POOL")) 
cat("Summary for all samples:")
summary(data$Final_pg.mg_C)

cat("Summary for good quality samples only:")
temp <- data %>% 
  filter(Failed_samples == 
           "OK")
summary(temp$Final_pg.mg_C)

kable(tail(data[ , c("Sample", "Final_pg.mg_A", "Final_pg.mg_B", "Final_pg.mg_C", "Spike_contribution", "Binding.Perc", "SpikeVol_ul", "Dilution_sample", "Dilution_spike", "Extraction_ratio")]), n= 3)

```

# Plots 

## (A) Standard Calculation

Final cortisol concentrations not accounting for spike. Tags are sample numbers.

Expected results: a straight horizontal line showing that I obtained same cortisol concentration value in the Y axis, across different sample weights.

```{r echo = FALSE, warning=FALSE }
# scatterplot method A

data <- data %>%
  filter(!Sample %in% c("B0", "BE", "NSB", "POOL")) #TA6","TA7","TB7","TC7", "TC6","TC5", #"TA2","TC3", "TD6", "TD7", "TB6", "TA1", "TB1", "TD1")

data$Spike <- replace(data$Spike, data$Spike == 1, 'Yes')
data$Spike <- replace(data$Spike, data$Spike == 0, 'No')
data$Buffer <- data$Buffer_ml
data$Buffer <- replace(data$Buffer, data$Buffer == 0.06, '60 uL')
data$Buffer <- replace(data$Buffer, data$Buffer == 0.11, '110 uL')
data$Buffer <- replace(data$Buffer, data$Buffer == 0.22, '220 uL')
data$Buffer <- replace(data$Buffer, data$Buffer == 0.25, '250 uL')

ggplot(data, aes(y = Final_pg.mg_A, 
                 x = 1:length(data$Sample), 
                 color = Failed_samples,
                 shape = Buffer)) +
  geom_point(size = 2.5, alpha = 0.85) +  
  geom_text(aes(label = Sample), size = 2.5, vjust = -0.65, hjust = -0.18) +
    theme_minimal() +  
  geom_hline(yintercept = 0, 
             linetype = "dashed", color = "red") +
  #xlim(0,52) +
  labs(
    title = "(A) Standard Calculation Cortisol Values",
    y = "Final Concentration (pg/mg)",
    x = "Sample") + 
  theme(
    plot.title = element_text(hjust = 0.5, 
                              size = 17, face = "bold"),
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 10)  
  ) + 
  scale_color_paletteer_d("vangogh::CafeTerrace")
```

## (B) Accounting for Spike

Final cortisol concentrations accounting for Spike as instructed in Nist et al. 2020.

Expected results: lower values than in the previous plot for the spiked samples, but not as low as negative samples (for all of them). Spiked and non-spiked samples should be aligned (same concentration across different weights)

```{r echo = FALSE, warning=FALSE }

data <- data %>%
  filter(!Sample %in% c("B0", "BE", "NSB", "POOL"))
#TA6","TA7","TB7","TC7", "TC6","TC5", #"TA2","TC3", "TD6", "TD7", "TB6", "TA1", "TB1", "TD1")

# scatterplot
ggplot(data, aes(y = Final_pg.mg_B, 
                 x = 1:length(data$Sample), 
                 color =  Failed_samples,
                 shape = Buffer)) +
  geom_point(size = 2.5,  alpha = 0.85) +  
  geom_text(aes(label = Sample), size = 3, vjust = -1, hjust = -0.1) +
  theme_minimal() +  
  #xlim(0,52) +
  geom_hline(yintercept = 0, 
             linetype = "dashed", color = "red") +
  labs(
    title = "(B) Calculation Accounting for Spike",
    y = "Final Concentration (pg/mg)",
    x = "Sample" ) +
  theme(
    plot.title = element_text(hjust = 0.5, 
                              size = 17, face = "bold"),
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 10)  
  ) + 
  scale_color_paletteer_d("vangogh::CafeTerrace")

```

## (C) Sam's calculation

Final cortisol concentration values using new method.

Expected results: one unique horizontal line, regardless of the spiking status and dilution. 

```{r echo = FALSE, warning=FALSE }

data <- data %>%
  filter(!Sample %in% c("B0", "BE", "NSB", "POOL"))
#TA6","TA7","TB7","TC7", "TC6","TC5", #"TA2","TC3", "TD6", "TD7", "TB6", "TA1", "TB1", "TD1")


ggplot(data, aes(y = Final_pg.mg_C, 
                 x = 1:length(data$Sample), 
                 color = Failed_samples,
                 shape = Buffer)) +
  geom_point(size = 2.5,  alpha = 0.85) +  
  geom_text(aes(label = Sample), size = 3, vjust = -1, hjust = -0.1) +
  theme_minimal() +  
 #   ylim(-26,30) +
  #xlim(0,52) +
  geom_hline(yintercept = 0, 
             linetype = "dashed", color = "red") +
  labs(
    title = "(C) Sam's calculation",
    y = "Final Concentration (pg/mg)",
    x = "Sample" ) +
  theme(
    plot.title = element_text(hjust = 0.5, 
                              size = 17, face = "bold"),
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 10)  
  )+ 
  scale_color_paletteer_d("vangogh::CafeTerrace")



# scatterplot
dataplot <- filter(data, Category == "A" | Category =="Standard" | Category == "B" | Category == "C" | Category == "D", !is.na(Binding.Perc)) 

ggplot(dataplot, aes(y = Final_pg.mg_C, 
                 x = 1:length(dataplot$Sample), 
                 color = Failed_samples,
                 shape = Buffer)) +
  geom_point(size = 2.5,  alpha = 0.85) +  
  geom_text(aes(label = Sample), size = 3, vjust = -1, hjust = -0.1) +
  theme_minimal() +  
 #   ylim(-26,30) +
  #xlim(0,52) +
  geom_hline(yintercept = 0, 
             linetype = "dashed", color = "red") +
  labs(
    title = "(C) Sam's calculation",
    y = "Final Concentration (pg/mg)",
    x = "Sample" ) +
  theme(
    plot.title = element_text(hjust = 0.5, 
                              size = 17, face = "bold"),
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 10)  
  )+ 
  scale_color_paletteer_d("vangogh::CafeTerrace")


dataplot <- filter(data, Category == "P", !is.na(Binding.Perc)) 

ggplot(dataplot, aes(y = Final_pg.mg_C, 
                 x = 1:length(dataplot$Sample), 
                 color = Failed_samples,
                 shape = Buffer)) +
  geom_point(size = 2.5,  alpha = 0.85) +  
  geom_text(aes(label = Sample), size = 3, vjust = -1, hjust = -0.1) +
  theme_minimal() +  
 #   ylim(-26,30) +
  #xlim(0,52) +
  geom_hline(yintercept = 0, 
             linetype = "dashed", color = "red") +
  labs(
    title = "(C) Sam's calculation, Precision",
    y = "Final Concentration (pg/mg)",
    x = "Samples" ) +
  theme(
    plot.title = element_text(hjust = 0.5, 
                              size = 17, face = "bold"),
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 10)  
  )+ 
  scale_color_paletteer_d("vangogh::CafeTerrace")

```


## (C) Contribution of spike 
```{r echo = FALSE}

ggplot(data, aes(y = Spike_contribution, 
                  x = 1:length(Sample), 
                  color = (Failed_samples))) + 
                 # fill = factor(Spike_contribution))) +
  geom_point(size = 3) +  
  geom_text(label = c(data$Sample), nudge_y = 40, nudge_x = 0, size = 1.8) +
 # geom_hline(yintercept = mean(data$Final_pg.mg), 
  #           color = "gray80",
   #          linetype = "dashed") +
  theme_minimal() +  
  labs(
    title = "Spike contribution and quality of each sample",
    y = "Spike contribution (pg/mg)",
    x = "Sample"  
  ) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),  
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 12) 
  ) 

```


# Evaluation using C 

```{r message=FALSE, echo = FALSE}
# All samples 
data2 <- data

#two datasets, separated by spike
data2.sp <- data2[data2$Spike == "Yes", ]
data2.nsp <- data2[data2$Spike == "No", ]

#### fit models ####

# model all
model.all <- lm(Final_pg.mg_C ~ Weight_mg, 
              data = data2)
r_squared.all <- summary(model.all)$r.squared

# model Spike
model.sp <- lm(Final_pg.mg_C ~ Weight_mg, 
              data = data2.sp)
r_squared.sp <- summary(model.sp)$r.squared
model.nsp <- lm(Final_pg.mg_C ~ Weight_mg, 
              data = data2.nsp)
r_squared.nsp <- summary(model.nsp)$r.squared

# Calculate residuals
residuals.all <- residuals(model.all)
residuals.sp <- residuals(model.sp)
residuals.nsp <- residuals(model.nsp)

residuals.all
residuals.sp
residuals.nsp
# Quantify residuals

# Mean Absolute Error
mae.all <- mean(abs(residuals.all))      
# Standard Deviation of Residuals
std_dev.all <- sd(residuals.all)

# Mean Absolute Error
mae.sp <- mean(abs(residuals.sp))      
# Standard Deviation of Residuals
std_dev.sp <- sd(residuals.sp)

# Mean Absolute Error
mae.nsp <- mean(abs(residuals.nsp))      
# Standard Deviation of Residuals
std_dev.nsp <- sd(residuals.nsp)

```

```{r plot, message=FALSE, echo = FALSE}
# scatterplot

ggplot(data2, aes(y = Final_pg.mg_C, 
                  x = 1:length(Sample), 
                  color = Buffer, 
                  fill = Buffer)) +
  geom_point(size = 2.5) +  
  geom_text(label = c(data2$Sample), nudge_y = 0.75, nudge_x = -0.5) +
  geom_smooth(method = "lm", 
              color = "gold3", 
              se = TRUE, alpha = 0.2) + 
  geom_hline(yintercept = mean(data2$Final_pg.mg_C), 
             color = "gray80",
             linetype = "dashed") +
  theme_minimal() +  
  ylim(0, max(data2$Final_pg.mg_C)+4) + 
  labs(
    title = "Final Cort Concentration by buffer
    (All samples) method C",
    y = "Final Concentration (pg/mg)",
    x = "Sample number"  
  ) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),  
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 12) 
  ) +
  # Add R^2 annotation
  annotate("text", x = 5, 
           y = max(data2$Final_pg.mg_C) * 0.84,
           label = paste("R² =", round(r_squared.sp, 3)), 
           size = 5, color = "black")


ggplot(data2, aes(y = Final_pg.mg_C, 
                  x = 1:length(Sample),
                  fill= Category)) +
  geom_point(size = 2.5) +  
  geom_text(label = c(data2$Sample), nudge_y = 0.75, nudge_x = -1, size = 2) +
  geom_smooth(method = "lm", 
              color = "gold3", 
              se = TRUE,
              alpha = 0.3) + 
  geom_hline(yintercept = mean(data2$Final_pg.mg_C), 
             color = "lightblue3",
             linetype = "dashed") +
  theme_minimal() +  
  labs(
    title = "Final Cort Concentration by Category
    (All samples) method C",
    y = "Final Concentration (pg/mg)",
    x = "Sample number"  
  ) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),  
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 12) 
  ) +
  # Add R^2 annotation
  annotate("text", x = max(data2$Weight_mg) * 0.7, 
           y = max(data2$Final_pg.mg_C),
           label = paste("R² =", round(r_squared.all, 2)), 
           size = 5, color = "black")
```

## Optimal dilution (using method C results)

**Error using spiked samples only**
```{r echo = FALSE}
cat("Mean Absolute Error (MAE) ALL:", round(mae.sp, 3), "\n") 
cat("Standard Deviation of Residuals ALL:", round(std_dev.sp, 3), "\n")
```
**Error using non-spiked samples only**
```{r echo = FALSE}
cat("Mean Absolute Error (MAE) ALL:", round(mae.nsp, 3), "\n") 
cat("Standard Deviation of Residuals ALL:", round(std_dev.nsp, 3), "\n")
```
**Error using all samples**
```{r echo = FALSE}
cat("Mean Absolute Error (MAE) ALL:", round(mae.all, 3), "\n") 
cat("Standard Deviation of Residuals ALL:", round(std_dev.all, 3), "\n")
```
