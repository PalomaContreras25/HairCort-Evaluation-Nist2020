---
title: "Results"
author: "Paloma"
date: "2024-10-16"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---
# Introduction

Here I use QCed results from an ELISA plate. All hair samples were obtained from the same person. I tested 3 variables:

- dilution (60 uL vs 250 uL, coded as 0 and 1, respectively)

- weight (11 to 37.1 mg)

- spike (25 uL stock solution (1:10) added to some wells, coded as 0 and 1, meaning not-spiked and spiked)


I removed the samples that have a Coef of variation higher than 15%.

```{r libraries, echo = FALSE, warning = FALSE, message=FALSE}
# Install libraries
library(dplyr)
library(knitr)
library(ggplot2)
library(RColorBrewer)
library(stats)
library(coefplot)
library(arm)
library(bbmle)
```

# Summary of results 

The **figures** below were used to decide that the **optimal parameters** are:

- **Weight** higher than 20, ideally. Binding deviation goes down with higher weight.
- **Dilution** between 60 and 250 ul (higher dilution provides lower coef. of variation, more lower dilutions locate samples closer to 50% binding. An intermedieate value would be best)
- **Spike** Non-spiked samples provide lower binding deviation from 50% (i.e. measures are close to falling outside the curve) 



```{r scatterplot 2, message=FALSE, fig.height = 4.5, fig.width = 7}

data <- read.csv("./data/Data_QC_filtered.csv")

# Scatter plot of Binding Percentage vs Weight

ggplot(data, aes(x = Weight_mg, 
                 y = Binding.Perc, 
                 shape = factor(Buffer_nl))) +
  geom_point(size = 3, color = "turquoise3") +
  geom_smooth(method = "lm", se = FALSE, linewidth = 0.4, color = "orange3") +  # Add a trend line
  geom_hline(yintercept = 50, linetype = "dashed", 
             color = "gray", linewidth = 1) +  # Add horizontal line 
  labs(title = "Results separated by spiked/non-spiked",
       x = "Weight (mg)", y = "Binding Percentage",
       shape = "Buffer Amount (ul)") +
  scale_y_continuous(n.breaks = 10) +  
  scale_shape_discrete(labels = c("60 uL", "250 uL")) +
  facet_grid( ~ Spike, labeller = as_labeller(c("0" = "Not spiked", "1" = "Spiked"))) +
  theme_minimal()

``` 
Here we see the effect of the spike more clearly: adding a spike may not be necessary unless we have very small samples.


The following plots were made considering that having a binding of 50% is ideal. Data points that are over 80% or under 20% are not within the curve, and predictions are less accurate. 


## Binding percentages
### Binding percentage by different variables

```{r scatterplot 1, message =FALSE}

# Scatter plot of Binding Percentage vs Weight, 4 groups

ggplot(data, aes(x = Weight_mg, 
                 y = Binding.Perc, 
                 color = factor(Spike), 
                 shape = factor(Buffer_nl))) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se = FALSE, linewidth = 0.5) +  # Add a trend line
  geom_hline(yintercept = 50, linetype = "dashed", 
             color = "gray", linewidth = 1) +  # Add horizontal line
  labs(title = "Binding Percentage vs Weight, 4 groups",
       x = "Weight (mg)", 
       y = "Binding Percentage",
       color = "Spike Status",  
       shape = "Buffer Amount (ul)") +
  scale_y_continuous(n.breaks = 10) +  
  theme_minimal() +
  # Change the labels in the legend using labs
  scale_color_discrete(labels = c("No Spike", "Spike Added")) +  # Change color legend labels
  scale_shape_discrete(labels = c("60 uL", "250 uL"))  

```

- **Spiked** samples (turquoise) have lower binding, because they have higher levels of cortisol than non spiked (pink) samples. 

- **Dilution**: effect is less clear. We see samples with both 60 uL and 250 uL binding at very high and very low levels. 

- **Trends**: within non-spiked samples with a similar weight and diluted at 60uL (pink circles), we do not obtain consistent binding percentages. However, non-spiked samples with similar weights do obtain similar bindings, and the lines are in the expected direction (higher weight, lower binding), except by a few outliers that would be removed from the analysis anyway (for having binding over 80%)

- **Conclusion**: samples across different weights, **non-spiked, and diluted in 250 uL buffer seem to provide the best results**, particularly if samples **weigh more than 15 mg**. Using less than that may be risky, and in those cases, it may be better to use less buffer to concentrate the samples a bit more. 




### Value distributions by group (boxplots) 

```{r boxplot1, echo = FALSE}
## Boxplot of Binding Percentage by dilution

ggplot(data, aes(x = factor(Spike), 
                 y = Binding.Perc, 
                 fill = factor(Spike))) +
  geom_boxplot() +
  geom_hline(yintercept = 50, linetype = "dashed", 
             color = "gray", linewidth = 1) + 
  labs(title = "Binding Percentage by Dilution",
       x = "", 
       y = "Bindings Percentage") +
  scale_y_continuous(n.breaks = 10) +  
  theme(legend.position = "none") +
  facet_wrap(~ Buffer_nl,  
             labeller = as_labeller(c("0" = "60 uL", 
                                      "1" = "250 uL"))) +
    scale_x_discrete(labels = c("Not spiked", "Spiked")) 
```

Here we also see that the impact of the spike on the values is larger than the impact of using a different dilution


## Coef. of variation percentage

The coefficient of variation or CV is a standardized measure of the difference between duplicates (same sample, same weight, same dilution, same everything). Some variables may make duplicates more variable, so this is what will be tested below.  

### Coef. of variation by group
```{r CVbyGroup, echo=FALSE}
# Boxplot of CV Percentage vs Buffer & Spike

ggplot(data, aes(x = factor(Spike), 
                 y = CV.Perc, 
                 fill = factor(Spike))) +
  geom_boxplot() +
  labs(title = "Coef. of variation by dilution and spike",
       x = "", 
       y = "Coef. of variation (%)") +
  scale_y_continuous(n.breaks = 10) +  
  theme(legend.position = "none") +
  facet_wrap(~ Buffer_nl,  
             labeller = as_labeller(c("0" = "60 uL", 
                                      "1" = "250 uL"))) +
    scale_x_discrete(labels = c("Not spiked", "Spiked")) 
```

**Conclusion** diluting the sample less seems to lead to higher differences between duplicates, which is something we want to avoid. We also see less variation for the group of spiked samples, with the lowest average of the four groups. Yet, we also must note that the spiked, 250 uL group has only 6 samples, as we see on the table below.

<table>
<caption><span id="tab:table">Num_of_samples </span></caption>

Dilution:              No spike       Spiked
------              -------------  ---------
60 uL                   7          7
250 uL                    12          6
Total: 32 samples
</table>

### Coef. of variation by different variables

```{r message =FALSE, echo=FALSE}

# Scatter plot of CV Percentage vs Weight, 4 groups

ggplot(data, aes(x = Weight_mg, 
                 y = CV.Perc, 
                 color = factor(Spike), 
                 shape = factor(Buffer_nl))) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se = FALSE, linewidth = 0.5) +  
  labs(title = "Coef. of variation Percentage vs Weight, 4 groups",
       x = "Weight (mg)", 
       y = "Coef. of variation (%)",
       color = "Spike Status",  
       shape = "Buffer Amount (ul)") +
  scale_y_continuous(n.breaks = 10) +  
  theme_minimal() +
  # Change the labels in the legend using labs
  scale_color_discrete(labels = c("No Spike", "Spike Added")) +  # Change color legend labels
  scale_shape_discrete(labels = c("60 uL", "250 uL"))  

```

**Lower CV** is seen in spiked + 250 uL group, particularly for samples with low weight. Yet, non spiked, diluted in 250uL samples have very low CV if weight is over 30. 

## Deviation from 50% binding

Here I calculate a "binding" deviation score, to have a better idea of the "distance" between the values obtained and what I should aim for: 50% binding. Here an example of how this score works:

```{r calc binding deviation, echo=FALSE}

data$Binding_deviation <- abs(data$Binding.Perc - 50)
sorted_data <- data[order(data$Binding_deviation), ]

# View top results (closest to 50% Binding Percentage)
kable(head(sorted_data[,c("Sample", "Binding.Perc", "Binding_deviation")]))

```


```{r plot_deviation, message=FALSE, echo = FALSE, include = TRUE}

# Scatter plot of Binding Deviation vs Weight, 4 groups

ggplot(data, aes(x = Weight_mg, 
                 y = Binding_deviation, 
                 color = factor(Spike), 
                 shape = factor(Buffer_nl))) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se = FALSE, linewidth = 0.5) +  
  labs(title = "Binding Deviation vs Weight, 4 groups",
       x = "Weight (mg)", 
       y = "Binding Deviation",
       color = "Spike Status",  
       shape = "Buffer Amount (ul)") +
  scale_y_continuous(n.breaks = 10) +  
  theme_minimal() +
  # Change the labels in the legend using labs
  scale_color_discrete(labels = c("No Spike", "Spike Added")) +  # Change color legend labels
  scale_shape_discrete(labels = c("60 uL", "250 uL"))  

```

This plot suggests that for samples of weight lower than 20 mg, adding a spike lowers the binding deviation. This effect is lost if samples are heaver than 20 mg. 

```{r dev. scatter, message=FALSE, echo=FALSE, fig.height = 4.5, fig.width = 7}

# Scatter plot of Binding deviation vs Weight, 2 groups (by dilution)

ggplot(data, aes(x = Weight_mg, 
                 y = Binding_deviation, 
                 shape = factor(Buffer_nl))) +
  geom_point(size = 3, color = "gray40") +
  geom_smooth(method = "lm", se = FALSE, linewidth = 0.5, color = "orange2") +  # Add a trend line
   labs(title = "Binding Percentage vs Weight, 2 groups (by spike)",
       x = "Weight (mg)", y = "Binding Deviation",
       shape = "Buffer Amount (ul)") +
  scale_y_continuous(n.breaks = 10) +  
  scale_shape_discrete(labels = c("60 uL", "250 uL")) +
  facet_grid( ~ Spike, labeller = as_labeller(c("0" = "Not spiked", "1" = "Spiked"))) 

```

We observe that spiked samples have a higher deviation from the ideal binding. We also observe that having larger samples leads to values closer to 50%. It is interesting to see that error does not go below 15% if we look at samples with weight under 20mg. Yet, we know that a deviation of up to 30% is acceptable. 

```{r boxplot_deviation, message=FALSE, echo = FALSE}

ggplot(data, aes(x = factor(Spike), 
                 y = Binding_deviation, 
                 fill = factor(Spike))) +
  geom_boxplot() +
  labs(title = "Binding deviation, by dilution and spike",
       x = "", 
       y = "Binding deviation") +
  scale_y_continuous(n.breaks = 10) +  
  theme(legend.position = "none") +
  facet_wrap(~ Buffer_nl,  
             labeller = as_labeller(c("0" = "60 uL", 
                                      "1" = "250 uL"))) +
    scale_x_discrete(labels = c("Not spiked", "Spiked")) 
  
```

Here we see how the lowest (best) scores are obtained by the non-spiked groups. Even better results are obtained if the dilution is 250 uL. 

- **Conclusion**: using a **250 uL dilution, without spikes**, will lead to **better results** that fall in the middle of the curve, and allow for more precise calculations of cortisol concentration. 

# Analysis: linear models

To explore the effects of each variable more systematically, I run multiple models and compared them using AIC Akakikes' coefficient. I removed samples with a binding over 80% or under 20%.

```{r qqplot, echo = FALSE}

weight <- data$Weight_mg
binding <- data$Binding.Perc
x <- mean(binding)


# Q-Q Plot
qqnorm(binding, pch = 16, col = "gray40")
qqline(binding, col = "orange3", lwd = 1.5)

```
First, I looked at the distribution of the data (binding percentage). I am not sure how to describe it, but it does not look very linear. I will test different distributions at another time, but for now, I will run and compare simple models that should allow me to understand which variables have a greater impact on binding percentages.

```{r models dif weights, echo = FALSE, include = FALSE}
mod <- lm(binding ~ weight)
summary(mod)

plot(weight, binding,
     main = "Linear regression ~ weight",
     xlab = "Weight",
     ylab = "binding %",
     pch = 16,
     cex = 1.3, 
     col = "gray40")

abline(mod, col = "orange3", lwd = 1.5)

# 20
d<- data[c(data$Weight_mg >= 20 & data$Weight_mg <= 29.9), ]
weight <- d$Weight_mg
binding <- d$Binding.Perc

# Q-Q Plot
qqnorm(binding, pch = 16, col = "cyan3")
qqline(binding, col = "red", lwd = 1.5)

## Linear regression
mod <- lm(binding ~ weight)
summary(mod)

plot(weight, binding,
     main = "Linear regression, weight 20 - 29.9 mg",
     xlab = "weight",
     ylab = "binding %",
     pch = 8,
     cex = 1, 
     col = "darkgreen")

abline(mod, col = "red", lty = 'dashed')

# 30

## Linear regression, by weight group
d<- data[c(data$Weight_mg > 29.9), ]
weight <- d$Weight_mg
binding <- d$Binding.Perc

# Q-Q Plot
qqnorm(binding, pch = 16, col = "cyan3")
qqline(binding, col = "red", lwd = 1.5)

## Linear regression
mod <- lm(binding ~ weight)
summary(mod)

plot(weight, binding,
     main = "Linear regression, weight over 30 mg",
     xlab = "weight",
     ylab = "binding %",
     pch = 8,
     cex = 1, 
     col = "darkgreen")

abline(mod, col = "red", lty = 'dashed')
```

```{r models dif spike, include = FALSE}
## Linear regression, by spike
## YES
d<- data[c(data$Spike == 1), ]
weight <- d$Weight_mg
binding <- d$Binding.Perc

# Q-Q Plot
qqnorm(binding, pch = 16, col = "cyan3", main = "qqplot, spiked samples")
qqline(binding, col = "red", lwd = 1.5)

## Linear regression
mod <- lm(binding ~ weight)
summary(mod)

plot(weight, binding,
     main = "Linear regression, spiked",
     xlab = "weight",
     ylab = "binding %",
     pch = 16,
     cex = 1, 
     col = "darkgreen")

abline(mod, col = "red", lty = 'dashed')


## Linear regression, by spike
## NO

d<- data[c(data$Spike == 0), ]
weight <- d$Weight_mg
binding <- d$Binding.Perc

# Q-Q Plot
qqnorm(binding, pch = 16, col = "cyan3", main = "qqplot, NONspiked samples")
qqline(binding, col = "red", lwd = 1.5)

## Linear regression
mod <- lm(binding ~ weight)
summary(mod)

plot(weight, binding,
     main = "Linear regression, not spiked",
     xlab = "weight",
     ylab = "binding %",
     pch = 16,
     cex = 1, 
     col = "darkgreen")

abline(mod, col = "red", lwd = 1.5)


```


#Work in progress after this line
______________________

