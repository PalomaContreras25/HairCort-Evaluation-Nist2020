---
title: "ELISA data analysis"
author: "Paloma"
output:  
  workflowr::wflow_html:
    theme:
      version: 5
      bootswatch: zephyr   # or cosmo, litera, sandstone, zephyr, etc.
      primary: "#00BFA5"   # accent color
      secondary: "#C2185B"   # 
      success: "#28A745"     #
      info: "#FFC107"        # 
      warning: "#FFC107"     # 
      danger: "#E83E8C"  
      base_font: {google: "Exo 2"}
      heading_font: {google: "Raleway"}
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    code_folding: show     # or "hide"
    code_download: true
    highlight: tango       # code syntax theme (tango, pygments, zenburn, etc.)
    df_print: paged        # nicer tables by default
    anchor_sections: true
    smooth_scroll: true
    
params:
  plate: "Test10"        # one of: Test3 ... Test10
  data_root: "./data"   # parent dir that holds Test3, Test4, ...
  spike_std: "st1" 
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
plate     <- params$plate
data_root <- params$data_root
spike_std <- params$spike_std
plate_dir <- file.path(data_root, plate)
plate_short <- paste0("T", sub("^Test", "", plate))  # "Test9" -> "T9"
# Path helper: p("file.csv") -> "./data/Test9/file.csv"
p <- function(...) file.path(plate_dir, ...)

# Keep figures per-plate (optional but tidy)
# fig_dir <- file.path(plate_dir, "figs")
# dir.create(fig_dir, recursive = TRUE, showWarnings = FALSE)
# knitr::opts_chunk$set(fig.path = paste0(fig_dir, "/"))

```
```{r libraries, include = FALSE, message=FALSE}
# Libraries 
library(knitr)
library(tidyverse)
library(janitor)
library(readr)
library(stringr)
library(dplyr)
library(ggrepel) # for labels on data points
library(gridExtra)
library(GGally) ## for association plots
library(gt) ## for nicer tables
```

# Overview

This file documents all the transformations done to obtain final cortisol values for the ELISA plate called: 

```{r platenum, echo = FALSE}
cat(plate)
```

This is how final values were obtained: 

    |-- Plate reader produces optical density (OD) values
          |
          |
          |---> Myassays.com uses ODs and map of plate layout to:
          
               1) Subtract readings for the NSB (non-specific binding, 0% binding) well 
                  from all values
                  
               2) Normalize all values, dividing them by the reading for the zero standard 
                  (blank, or B0, 100% binding)
                  
               3) Fit a 4-Parameter Logistic curve (for a sigmoidal shape) 
                  to the standard readings
                  
               4) Extrapolate cortisol concentration values from the standard curve
                      * Obtained values for each replicate separately by 
                      treating them as a single sample when providing 
                      the plate layout
                      * These values do not control for differences 
                      in dilution, sample weight, spike, etc. 
                      * Values obtained are in the same unit as the
                      standards provided (pg/ml)
                      * Flagged samples were labeled as such in SampleInfo.csv file
                           |
                           |
                           |----> In R, I calculate final values using two formulas:
                                  A) Traditional used across studies
                                  B) Alternative, accounts for Spike (when necessary)

**Example** with actual results from Plate 10:

|ID.  | Optical Density | OD-NSB (0.05) | B/B0 (0.792) *100| Conc (pg/ml) extrapolated from std curve (A)|
|---|----|-----|-----|-------|
|T100.  | 0.373 | 0.323 |     41%      | 916.1 |
|T100.  | 0.383 | 0.333 |     42%      | 871   |


Now, using the formula A * F / B * C / D * E, we calculate the normalized final concentration value, adjusted for mass, extraction and reconstitution volumes.

| A (Concentration in pg/ml) | B (Mass in mg) | C (MeOH added in mL) | D (MeOH recovered in mL) | E (Reconstitution volume in mL) | F (Sample dilution factor) | Result in pg/mg |
|-----------|------------|--------------|--------------|-----------------|-----------|---|
|    916.1  | 16   | 1.4. |  1. |  0.22  |  1.  | 17.6 |
|    871    | 16   | 1.4  |  1  |  0.22  |  1.  | 16.7 |


Check Rmarkdown file to see the code used to clean and merge data frames. 

### Input files
All located in ./HairCort-Evaluation-Nist2020/data/TestX

- **Results**:
```{r echo=FALSE}
cat(paste("ResultsMyAssaysIndiv_", plate_short, ".csv", sep=""))
```
- **Results for Standards**:
```{r echo=FALSE}
cat(paste("ResultsMyAssaysIndiv_", plate_short, "_st.csv", sep=""))
```
- **Sample information**:
```{r echo=FALSE}
cat("SampleInfo.csv")
```
```{r loading files, echo = FALSE}
# Loading files
results  <- read.csv(p(paste0("ResultsMyAssaysIndiv_", plate_short, ".csv")),
                     stringsAsFactors = TRUE,
                     na.strings = c("", " ", "NA"))

standard <- read.csv(p(paste0("ResultsMyAssaysIndiv_", plate_short, "_st.csv")),
                     stringsAsFactors = TRUE,
                     na.strings = c("", " ", "NA"))

info <- read.csv(p("SampleInfo.csv"),
                 stringsAsFactors = TRUE,
                 na.strings = c("", " ", "NA"))

output_path <- p(paste0("Merged_ELISA_results_", plate, ".csv"))
```
```{r cleaning results and standard file, echo = FALSE}

# Clean Results file

results_clean <- results %>%
        dplyr::rename(                 # rename columns
          Well = Wells,
          OD = Raw,
          Binding_perc = X.,
          Conc_pg_ml = Conc., 
          Ave_conc_pg_ml = Conc...Average.,
          CV_perc = X.CV
        ) %>%
       mutate(across(everything(),     # replace unreadable or non-numeric values
                    ~na_if(trimws(.), "-"))) %>% 
       mutate(Conc_pg_ml = na_if(Conc_pg_ml, "< Curve"),
             Conc_pg_ml = na_if(Conc_pg_ml, "> Curve")) %>%
       mutate(across(c(Binding_perc, Conc_pg_ml, Ave_conc_pg_ml, CV_perc, SEM),
                ~ as.numeric(as.character(.))))

  # fill down empty cells for replicates (merged cells in original file)
results_filled <- results_clean %>%
       mutate(.row_id = row_number()) %>% 
  
      fill(                  # Fill selected info forward until new sample appears
        Sample, Binding_perc,
        .direction = "down"
      ) %>%
      group_by(across(any_of(c("Plate_num", "Sample")))) %>%  # Create replicate index for each sample
      mutate(replicate = row_number()) %>%
      ungroup() %>%
      select(-.row_id, -replicate, -Sample)


# Clean Standard file

standard_clean <- standard %>%
  dplyr::rename(
   Sample = Calibrator,
   Well = Wells,
   Conc_pg_ml= Conc.,
   Binding_perc = Raw,
   Ave_conc_pg_ml = Backfit, 
   Std_recovery = Recovery..
    ) %>%
   mutate(across(everything(),     # replace unreadable or non-numeric values
                    ~na_if(trimws(.), "-"))) %>% 
   mutate(across(c(Ave_conc_pg_ml, Conc_pg_ml, Binding_perc, SEM),
                ~ as.numeric(as.character(.))))

  # fill down empty cells for replicates (merged cells in original file)
standard_filled <- standard_clean %>%
       mutate(.row_id = row_number()) %>% 
      fill(                  # Fill selected info forward until new sample appears
        Sample, Conc_pg_ml, SEM,
        .direction = "down"
      ) %>%
      group_by(across(any_of(c("plate_num", "Sample")))) %>%  # Create replicate index for each sample
      mutate(replicate = row_number()) %>%
      ungroup() %>%
      select(-.row_id, -replicate, -Sample)


## Simplify object names
res <- results_filled
st <- standard_filled
```
```{r merge files, echo = FALSE}
# Merge results and standard file 

res_st <- full_join(res, st, by = intersect(names(res), names(st)))

# Merge sample information and results/standards
data <-  full_join(info, res_st, by = intersect(names(res_st), names(info)))


data <- data %>%
  filter(Category != "Flagged") %>% # removed flagged samples
  mutate(across(c(Binding_perc, Conc_pg_ml, Ave_conc_pg_ml, SEM),
                ~ as.numeric(as.character(.))))
#extract values for the spike used in this plate
 std <- data[data$Sample == spike_std, c("Ave_conc_pg_ml")] 
```

# Results
## Binding Percentages and non-normalized cort values
```{r keep logical order, echo = FALSE}
data <- data[order(data$Order), ]
data$Sample <- factor(data$Sample, levels = unique(data$Sample))
```
```{r all.groups.binding.perc.cort, fig.width=8, fig.height=6, warning = FALSE, echo = FALSE}
# Scatter plot observed binding % and cort vals

ggplot(data, aes(x = log10(Ave_conc_pg_ml), 
                 y = Binding_perc, 
                 color = Category)) +
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = 80, ymax = Inf,
           alpha = 0.2, fill = "gray70") +
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = 0, ymax = 20,
           alpha = 0.2, fill = "gray70") +
  geom_point(size = 2) +
  geom_text(aes(label = Sample), 
            size = 2,  color = "gray30",
            vjust = -0.1, hjust = -0.2) +
  geom_hline(yintercept = 80, linetype = "dashed", 
             color = "gray", linewidth = 0.8) +
  geom_hline(yintercept = 20, linetype = "dashed", 
             color = "gray", linewidth = 0.8) +
  labs(title = "Binding % and log10 cortisol values",
       subtitle = "Non-corrected values (for weight, dilution), all samples",
       x = "Log10 Concentration (pg/mL)", y = "Binding Percentage") +
  theme_minimal() +
  scale_y_continuous(n.breaks = 10) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 

```
## Binding Percentages by Sample 
```{r all.groups.binding.perc.sample, fig.width=8, fig.height=6, echo = FALSE, warning=FALSE}
ggplot(data, aes(x = Sample, 
                 y = Binding_perc, 
                 color = Category)) +
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = 80, ymax = Inf,
           alpha = 0.2, fill = "gray70") +
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = 0, ymax = 20,
           alpha = 0.2, fill = "gray70") +
  geom_point(size = 2) +
  geom_text(aes(label = Sample), 
            size = 2.5, vjust = 0, hjust = -0.2, color = "gray40") +
  geom_hline(yintercept = 80, linetype = "dashed", color = "gray", linewidth = 0.8) +
  geom_hline(yintercept = 20, linetype = "dashed", color = "gray", linewidth = 0.8) +
  labs(title = "Binding % by Sample",
       subtitle = "Non-corrected values (for weight, dilution), all samples",
       x = "Sample ID", y = "Binding Percentage") +
  theme_set(theme_minimal(base_family = "Exo 2")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(n.breaks = 10)

```
## Binding Percentages by Sample, filtered out flagged samples 
```{r goodqual.groups.binding.perc.sample, fig.width=8, fig.height=6, warning=FALSE, echo = FALSE}

filtered <- data %>% 
  filter(Subcategory != "LowQual")

ggplot(filtered , aes(x = Sample, 
                 y = Binding_perc, 
                 color = Category)) +
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = 80, ymax = Inf,
           alpha = 0.2, fill = "gray70") +
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = 0, ymax = 20,
           alpha = 0.2, fill = "gray70") +
  geom_point(size = 2) +
  geom_text(aes(label = Well), 
            size = 2.5, vjust = 0, hjust = -0.2, color = "gray40") +
  geom_hline(yintercept = 80, linetype = "dashed", color = "gray", linewidth = 0.8) +
  geom_hline(yintercept = 20, linetype = "dashed", color = "gray", linewidth = 0.8) +
  labs(title = "Binding % by Sample",
       subtitle = "Non-corrected values (for weight, dilution), good quality samples only ",
       x = "Sample ID", y = "Binding Percentage") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(n.breaks = 10)

```
## Binding Percentages by Sample, averaged for replicates
```{r goodqual.ave.binding.perc.sample, fig.width=8, fig.height=6, echo = FALSE}
filtered <- filtered %>%
  group_by(Sample, Category) %>%
 summarise(
   Ave_conc_pg_ml = mean(Conc_pg_ml, na.rm = TRUE),
   Ave_binding_perc = mean(Binding_perc, na.rm = TRUE),
## ADD SEM (Standard error of the mean)
   Sd_binding = sd(Binding_perc, na.rm = TRUE),
   N = n(),
   Sem_binding = Sd_binding / sqrt(N)
  )


ggplot(filtered, aes(x = Sample, 
                 y = Ave_binding_perc, 
                 color = Category)) +
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = 80, ymax = Inf,
           alpha = 0.2, fill = "gray70") +
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = 0, ymax = 20,
           alpha = 0.2, fill = "gray70") +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = Ave_binding_perc - Sem_binding,
                    ymax = Ave_binding_perc + Sem_binding),
                width = 0.2, linewidth = 0.5) +
  geom_text(aes(label = Sample), 
            size = 2.5, vjust = 0, hjust = -0.2, color = "gray40") +
  geom_hline(yintercept = 80, linetype = "dashed", color = "gray", linewidth = 0.8) +
  geom_hline(yintercept = 20, linetype = "dashed", color = "gray", linewidth = 0.8) +
  labs(title = "Averaged Binding % by Sample",
       subtitle = "Non-corrected values (for weight, dilution), good quality samples only. Bars show SEM",
       x = "Sample ID", y = "Binding Percentage") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(n.breaks = 10)

```


# Results by hair count (if information exists)

```{r weight.hair.count, fig.width=8, fig.height=6, echo = FALSE}

if ("Num_strands" %in% names(data) && any(data$Num_strands != 0, na.rm = TRUE)) {
data_hc <- data %>% 
      filter(Subcategory == "HairCount") 

data_hc %>% 
    distinct(Sample, .keep_all = TRUE) %>%
    ggplot(aes(x = Num_strands, 
               y = Weight_mg,
                   fill = Category, 
                   group = Category)) +
      geom_smooth(method = "lm", se = TRUE, 
                  linewidth = 0.4, alpha = 0.09,
                  aes(color = Category)) +
      geom_text(aes(label = Sample), 
            size = 2.5, vjust = 0, 
            hjust = -0.2, color = "gray40") +
      geom_jitter(shape = 23, size = 3, 
                  alpha = 0.7, width = 0.3) +
      labs(title = "Hair count vs Weight ",
                 x = "Hair count", 
                 y = "Weight (mg)") +
      theme_minimal(base_size = 9) 
 
} else {
  
    message(paste("Skipping plot, data set does not have information on 
    the number of hair strands"))
  }

```
```{r  hair.vs.bindning, fig.width=8, fig.height=6, echo = FALSE}

if ("Num_strands" %in% names(data) && any(data$Num_strands != 0, na.rm = TRUE)) {
    data_hc %>% 
    ggplot(aes(x = Num_strands, 
               y = Binding_perc,
                   fill = Category, 
                   group = Category)) +
     annotate("rect", xmin = -Inf, xmax = Inf, 
              ymin = 80, ymax = Inf,
           alpha = 0.2, fill = "gray70") +
     annotate("rect", xmin = -Inf, xmax = Inf, 
           ymin = 0, ymax = 20,
           alpha = 0.2, fill = "gray70") +
      geom_smooth(method = "lm", se = TRUE, 
                  linewidth = 0.4, alpha = 0.09,
                  aes(color = Category)) +
      geom_jitter(shape = 23, size = 3, 
                  alpha = 0.7, width = 0.3) +
       labs(title = "Hair count vs Binding %",
                 x = "Hair count", 
                 y = "Binding %") +
      theme_minimal(base_size = 9) +
      geom_text(aes(label = Sample), 
            size = 2.5, vjust = 0, hjust = -0.3,
            color = "gray40") + 
      scale_y_continuous(n.breaks = 10) +
      scale_x_continuous(n.breaks = 10)
 
} else {
  
    message(paste("Skipping plot"))
  }



```
```{r  hair.vs.weight, fig.width=8, fig.height=6, echo = FALSE}

if ("Num_strands" %in% names(data) && any(data$Num_strands != 0, na.rm = TRUE)) {
    data_hc %>%
    ggplot(aes(x = Weight_mg, 
               y = Binding_perc,
                   fill = Category, 
                   group = Category)) +
     annotate("rect", xmin = -Inf, xmax = Inf, 
              ymin = 80, ymax = Inf,
           alpha = 0.2, fill = "gray70") +
     annotate("rect", xmin = -Inf, xmax = Inf, 
           ymin = 0, ymax = 20,
           alpha = 0.2, fill = "gray70") +
      geom_smooth(method = "lm", se = TRUE, 
                  linewidth = 0.4, alpha = 0.09,
                  aes(color = Category)) +
      geom_jitter(shape = 23, size = 3, 
                  alpha = 0.7, width = 0.3) +
       labs(title = "Weight vs Binding %",
                 x = "Weight (mg)", 
                 y = "Binding %") +
      theme_minimal(base_size = 9) +
      geom_text(aes(label = Sample), 
            size = 2.5, vjust = 0, hjust = -0.3,
            color = "gray40") + 
      scale_y_continuous(n.breaks = 10) +
      scale_x_continuous(n.breaks = 10)
 
} else {
  
    message(paste("Skipping plot"))
  }



```
```{r  hair.vs.bindning_facet, fig.width=8, fig.height=6, echo = FALSE}

if ("Num_strands" %in% names(data) && any(data$Num_strands != 0, na.rm = TRUE)) {
    data_hc %>% 
    ggplot(aes(x = Num_strands, 
               y = Binding_perc,
                   fill = Category, 
                   group = Category)) +
     annotate("rect", xmin = -Inf, xmax = Inf, 
              ymin = 80, ymax = Inf,
           alpha = 0.2, fill = "gray70") +
     annotate("rect", xmin = -Inf, xmax = Inf, 
           ymin = 0, ymax = 20,
           alpha = 0.2, fill = "gray70") +
      geom_smooth(method = "lm", se = TRUE, 
                  linewidth = 0.4, alpha = 0.09,
                  aes(color = Category)) +
      geom_jitter(shape = 23, size = 3, 
                  alpha = 0.7, width = 0.3) +
       labs(title = "Hair count vs Binding %",
                 x = "Hair count", 
                 y = "Binding %") +
      theme_minimal(base_size = 9) +
      geom_text(aes(label = Sample), 
            size = 2.5, vjust = 0, hjust = -0.3,
            color = "gray40") + 
      scale_y_continuous(n.breaks = 10) +
      scale_x_continuous(n.breaks = 10) +
    facet_wrap(~Category)
 
} else {
  
    message(paste("Skipping plot"))
  }



```
```{r  hair.vs.weight_facet, fig.width=8, fig.height=6, echo = FALSE}

if ("Num_strands" %in% names(data) && any(data$Num_strands != 0, na.rm = TRUE)) {
    data_hc %>% 
    ggplot(aes(x = Weight_mg, 
               y = Binding_perc,
                   fill = Category, 
                   group = Category)) +
     annotate("rect", xmin = -Inf, xmax = Inf, 
              ymin = 80, ymax = Inf,
           alpha = 0.2, fill = "gray70") +
     annotate("rect", xmin = -Inf, xmax = Inf, 
           ymin = 0, ymax = 20,
           alpha = 0.2, fill = "gray70") +
      geom_smooth(method = "lm", se = TRUE, 
                  linewidth = 0.4, alpha = 0.09,
                  aes(color = Category)) +
      geom_jitter(shape = 23, size = 3, 
                  alpha = 0.7, width = 0.3) +
       labs(title = "Weight vs Binding %",
                 x = "Weight (mg)", 
                 y = "Binding %") +
      theme_minimal(base_size = 9) +
      geom_text(aes(label = Sample), 
            size = 2.5, vjust = 0, hjust = -0.3,
            color = "gray40") + 
      scale_y_continuous(n.breaks = 10) +
      scale_x_continuous(n.breaks = 10) +
      facet_wrap(~Category)
 
} else {
  
    message(paste("Skipping plot"))
  }



```
```{r count,weight,binding, echo = FALSE}


if ("Num_strands" %in% names(data) && any(data$Num_strands != 0, na.rm = TRUE)) {
  
library(plotly)

ggpairs(data_hc,
        columns = c("Weight_mg", "Num_strands", "Binding_perc"),
        aes(color = Category))
} else {
  
    message(paste("Skipping plot"))
  }

if ("Num_strands" %in% names(data) && any(data$Num_strands != 0, na.rm = TRUE)) {
plot_ly(data,
        x = ~Weight_mg,
        y = ~Num_strands,
        z = ~Binding_perc,
        color = ~Category,
        colors = "Set1",
        type = "scatter3d",
        mode = "markers")
} else {
  
    message(paste("Skipping plot"))
  }

if ("Num_strands" %in% names(data) && any(data$Num_strands != 0, na.rm = TRUE)) {
library(reshape2)
cor_data <- cor(data_hc[, c("Weight_mg", "Num_strands", "Binding_perc")], use = "complete.obs")
melted <- melt(cor_data)

ggplot(melted, aes(Var1, Var2, fill = value)) +
  geom_tile() +
  geom_text(aes(label = round(value, 2)), color = "white") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0) +
  theme_minimal() +
  labs(title = "Correlation between Weight, Hair Strands, and Binding %") 

} else {
  
    message(paste("Skipping plot"))
  }


```


# Calculating final, normalized values
## Formula A (traditional)
  
        A * F / B * C / D * E = Cortisol concentration in pg/mg
  
        ▪ A = output myassays.com (pg/ml)
        ▪ B = sample mass (mg)
        ▪ C = methanol added for extraction (mL)
        ▪ D = methanol recovered (mL)
        ▪ E = reconstitution volume (mL)
        ▪ F = Sample dilution factor (2 if 1:2, 4 if 1:4)
        
```{r Calculate final values}
############################################################
##### Calculate final values not accounting for spike #####
############################################################

data$Final_pg_mg <- 
     (data$Conc_pg_ml * data$Dilution_factor_sample 
      / data$Weight_mg) *            # A / B *
     data$Extraction_ratio *         # C / D *
     data$Reconst_buffer_ml          # E 
```

```{r calculate average final vals and CV, echo = FALSE}
###### Calculate average final vals and CV ##### 
data <- data %>%
  group_by(Sample, Category) %>%
  filter(Subcategory != "Flagged") %>% 
  mutate(Ave_conc_pg_ml = (mean(Conc_pg_ml, na.rm = TRUE))) %>%
  mutate(Ave_Final_pg_mg = (mean(Final_pg_mg, na.rm = TRUE))) %>%
  mutate(CV_perc = (sd(Final_pg_mg, na.rm = TRUE) / mean(Final_pg_mg, na.rm = TRUE)) * 100) %>%
  mutate(z = (Final_pg_mg - mean(Final_pg_mg, na.rm = TRUE)) / sd(Final_pg_mg, na.rm = TRUE)) %>%
  ungroup()
```
## Formula B (accounting for spike)

Simplifies unnecessary unit transformations and accounts for spike considering dilution of both sample and the spike

- Step 1: Calculate contribution of the spike
- Step 2: Subtract spike from plate reading values and calculate final values accounting for dilution of the sample, weight, and reconstitution

**Step 1**: Calculate contribution of spike

X * Y / Z / SPd = SP

- SP = final value of spike contribution in pg/mL
- X = volume of spike added (mL)
- Y = concentration of the spike added (pg/mL)
- SPd = if serially diluted, dilution factor for the spike (i.e: 1, 2, 4, 8, etc.)
- Z = total volume (mL) in the well or tube, if spike is added before loading the plate (sample + spike)

```{r calc contrib spike}
# Calculating contribution of the spike

# consider spike volume added, either in the tube or the well
data$SpikeVol_ml <- data$Spike_well_ml + data$Spike_tube_ml 

# consider total volume of liquid added to the well, adding up spike, buffer and sample volumes
data$TotalVol_ml  <- data$Spike_well_ml + data$Sample_well_ml + data$Buffer_well_ml 

# reading for the standard used to spike samples
# I already run the following line, to save the std readings before overwritting the Ave_conc_pg_ml object
# std <- data[data$Sample == spike_std, c("Ave_conc_pg_ml")] 

# average both readings
std <- mean(std) 
  
# Calculate spike contribution to each sample
      ##  ( Spike vol. x Spike Conc.)
      ##   ------------------------  / dilution = Spike contribution (pg/ml)
      ##        Total vol. 
  
# Calculate cort contribution of spike to each sample
data$Spike_contribution <- ((data$SpikeVol_ml * std  /     # X * Y /
                            data$TotalVol_ml ) /           # Z / 
                              data$Dilution_factor_spike)  # SPd

# Null contributions equal zero
data <- data %>%
mutate(Spike_contribution = ifelse(is.na(Spike_contribution) | is.nan(Spike_contribution), 0, Spike_contribution))

```
```{r echo = FALSE}
cat("The reading for the standard used as spike (which is", spike_std, ") in this plate is", std, "(pg/ml)")
cat("The contribution of the spike, considering how much is added to the well, is", unique(data$Spike_contribution), "pg/ml")
```
**Step 2 **: Substract spike and calculate final values

((A - **SP**) * F /B) * (C/D) * E  = G

- A = pg/ml from assay output;
- *SP* = spike contribution (in pg/ml) 
- B = weight (in mg) of hair subjected to extraction;
- C = vol. (in ml) of methanol added to the powdered hair;
- D = vol. (in ml) of methanol recovered from the extract and subsequently dried down;
- E = vol. (in ml) of assay buffer used to reconstitute the dried extract;
- Sample dilution factor
- G = final value of hair CORT Concentration in pg/mg.

```{r calc-spike}
##################################
##### Calculate final values #####
##################################

data$Final_pg_mg_sp <- 
     ((data$Conc_pg_ml - data$Spike_contribution) * #  (A - spike)
         data$Dilution_factor_sample) /  #  * dilution factor /
     data$Weight_mg *                    # B *
     data$Extraction_ratio *             # C / D *
     data$Reconst_buffer_ml              # E 

```

### Results Formula B
```{r goodqual.ave.cort.vals, fig.width=8, fig.height=6, echo = FALSE}

filtered <- data %>% 
  filter(Subcategory != "LowQual", Person != "Ref_values", Person != "Spike",
         ) %>%
  group_by(Sample, Category) %>%
 summarise(
   Ave_Final_pg_mg_sp = mean(Final_pg_mg_sp, na.rm = TRUE),
## ADD SEM (Standard error of the mean)
   Sd_Final_pg_mg_sp = sd(Final_pg_mg_sp, na.rm = TRUE),
   N = n(),
   Sem_Final_pg_mg_sp = Sd_Final_pg_mg_sp / sqrt(N)
  )


ggplot(filtered, aes(x = Sample, 
                 y = Ave_Final_pg_mg_sp, 
                 color = Category)) +
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = 0,
           alpha = 0.2, fill = "gray70") +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = Ave_Final_pg_mg_sp - Sem_Final_pg_mg_sp,
                    ymax = Ave_Final_pg_mg_sp + Sem_Final_pg_mg_sp),
                width = 0.2, linewidth = 0.5) +
  geom_text(aes(label = Sample), 
            size = 3, vjust = 0, hjust = -0.2, color = "gray40") +
  labs(title = "Averaged Cort values, Formula B, by Sample",
       subtitle = "Corrected values (for weight, dilution), good quality samples only. Bars show SEM",
       x = "Sample ID", y = "Cort vals (pg/mg) accounting for Spike") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(n.breaks = 10)

```


# Quality
Flag samples with high coefficient of variation (replicate measurements that are too different from each other) or that fall outside the standard curve (binding percentage is above 80%, or under 20%)
```{r qc parameters}
# flag samples with high CV (15%) or binding above 80% and under 20%
CV_threshold <- 15.0
uppBinLim <- 80.0
lowBinLim <- 20.0
```

```{r flag issues, echo= FALSE}
# flag samples with binding percentage over 80 or under 20
data_qual <- data %>%
  mutate(Binding_perc_categ = ifelse(Binding_perc > uppBinLim, "ABOVE 80% binding", 
                                     ifelse(Binding_perc < lowBinLim, "UNDER 20% binding", 
                                            NA))) %>% 
  mutate(CV_categ = ifelse(data$CV_perc > CV_threshold,  
                           "HIGH CV", NA))

out_curve <- data_qual[!is.na(data_qual$Binding_perc_categ), ] 

cat(paste("Total samples outside the curve:", nrow(out_curve), "(some are blanks or NSB)", sep=" "))
print(out_curve[2:4])

cv_high <- data_qual %>% 
 filter(CV_perc > CV_threshold) %>% 
 arrange(desc(CV_perc))

cat("High CV in a total of", nrow(cv_high), "replicates. These are:")
print(cv_high[2:4])

```

```{r echo = FALSE}
# Visualize low quality samples
data_qual %>%
  filter(!Category == "Std", Category != "NSB", Category != "B0") %>%
ggplot(aes(x = Sample, y = Final_pg_mg), group = Binding_perc_categ) +
  geom_point() +
#  geom_boxplot() +
  labs(title = "Replicates per sample") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

cat("Samples with concerningly high CV values")

cat("Summary final cortisol values for all samples")
summary(data_qual$Final_pg_mg)

# remove outliers and recalculate CV
# remove <- c("D4", "D5", "E6", "C6")
# data_clean <- data_qual %>%
   # filter(!Wells %in% remove)


data_clean <- data_qual %>%
  group_by(Sample) %>%
  mutate(Ave_conc_pg_ml = (mean(Conc_pg_ml, na.rm = TRUE))) %>%
  mutate(CV.Perc = (sd(Conc_pg_ml, na.rm = TRUE) / 
                      mean(Conc_pg_ml, na.rm = TRUE)) * 100) %>%
  mutate(z = (Conc_pg_ml - mean(Conc_pg_ml, na.rm = TRUE)) /
           sd(Conc_pg_ml, na.rm = TRUE)) %>%
  ungroup()

ggplot(data_clean, aes(x = Sample, y = Conc_pg_ml)) +
  geom_point() +
  geom_boxplot()
```


## Plot: results grouped by category
```{r plot-by-categ, echo = FALSE, warning = FALSE, message = FALSE}

ggplot(data_clean, aes(y = Final_pg_mg, 
                  x = Sample,
                  color = Category,
                  fill= Category)) +
  geom_smooth(method = "lm", 
              color = "gold3", 
              se = TRUE,
              alpha = 0.2) + 
  geom_point(size = 2.5) +  
  ylim(0, max(data_clean$Final_pg_mg)) +
   geom_text(label = c(data_clean$Sample), nudge_y = 10, nudge_x = 0, size = 2) +
  theme_minimal() +  
  labs(
    title = "Final Cort Concentration by Category
    (All samples)",
    y = "Final Concentration (pg/mg)",
    x = "Sample number"  
  ) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),  
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 12) 
  ) 
```

## Plot: results grouped by category without outliers
```{r plot-by-categ-2, echo = FALSE, warning = FALSE, message = FALSE}

ggplot(data_clean, aes(y = Final_pg_mg, 
                  x = 1:length(Sample),
                  color = Category,
                  fill= Category)) +
  geom_smooth(method = "lm", 
              color = "gold3", 
              se = TRUE,
              alpha = 0.2) + 
     geom_point(size = 2.5) +  
     #  ylim(0,135) +
  geom_text(label = c(data_clean$Sample), nudge_y = 3, nudge_x = 0, size = 2.2) +
  theme_minimal() +  
  labs(
    title = "Final Cort Concentration by Category
    (All samples)",
    y = "Final Concentration (pg/mg)",
    x = "Sample number"  
  ) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),  
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 12) 
  ) 
```

## Plot: results grouped by data quality
```{r echo = FALSE, warning=FALSE }

# scatterplot 
ggplot(data_clean, aes(y = Ave_Final_pg_mg, 
                 x = order(Sample)
                 )) +
  geom_point(size = 2.5,  alpha = 0.85) +  
  geom_text(aes(label = Sample), size = 2.3, vjust = -1, hjust = 0.6) +
  theme_minimal() +  
 #    ylim(-26,30) +
  #   xlim(0,52) +
  geom_hline(yintercept = 0, 
             linetype = "dashed", color = "red") +
  labs(
    title = "Final cort values",
    y = "Final Concentration (pg/mg)",
    x = "Sample" ) +
  theme(
    plot.title = element_text(hjust = 0.5, 
                              size = 17, face = "bold"),
    axis.title = element_text(size = 14),  
    axis.text = element_text(size = 10)  
  )
```


```{r saving final file, echo=FALSE}

write_csv(data_qual , output_path)
print(glue::glue("Wrote {nrow(data_qual)} rows to {output_path}, with a total of {length(unique(data_qual$Sample))} data points, including reference values such as blanks and standards"))

cat("The final file has the following columns:")
print(colnames(data_qual))

cat("This is a list of all the samples included:")
print(unique(data_qual$Sample))
```

# Pending
```{r}

## Flaggs

## Plate CV

## Plave CV removing ref values

## Plate CV removing bad quality samples

## Plate map image
```




