---
title: "Analysis of final values - test8"
author: "Paloma"
date: "`r Sys.Date()`"
output: workflowr::wflow_html
editor_options: 
  chunk_output_type: console
---
# Introduction

Here I plan to include measurements and visualizations of the accuracy, precision, and linearity of ELISA #6. I will do this using two different ways of calculating final values: the standard method not accounting for spike, and an alternative method accounting for it. The way the spike is included in the formula is defined in file ELISA_Calc_FinalVals_test6.html.

*Plate description*

Category	  Description
---------  ---------------------------------------------------------------
T        	Non-spiked 


```{r echo=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r libraries, echo = FALSE, warning = FALSE, message=FALSE}
# Install libraries

library(knitr)
library(RColorBrewer)
library(stats)
library(coefplot)
library(arm)
library(bbmle)
library(plyr)
library(ggpmisc)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(broom)
```

```{r loading}
# Loading data
std <- read.csv("./data/Test8/standard_data_test8.csv")
data <- read.csv("./data/Test8/Data_cort_values.csv")
```

# Overall Results

```{r exp.Final_pg.mg_hair_count1, fig.width=8, fig.height=6}
# Scatter plot of Experiment A and B, observed binding % 

a <- filter(data, Category == "HairCount", !is.na(Final_pg.mg)) 

a$Sample_num <- 1:length(a$Sample)
cat(paste("Data has", nrow(a), "data points", sep= " "))

remove <- c("F11", "E11", "C11", "D11", "A8", "B8" )

a <- a %>%
  filter(!Wells %in% remove)

## PLOT WITHOUT POOR QUALITY SAMPLES ### 

ggplot(a, aes(x = weight_mg, 
                 y = Final_pg.mg, color = Person)) +
  geom_smooth(method = "lm", se = TRUE, linewidth = 0.4, alpha = 0.2, aes(group = a$Person)) +
  geom_point(size = 2) +
  geom_text(aes(label = Sample), size = 2.5, vjust = -1, hjust = 0.5, color = "gray30") +
  geom_hline(yintercept = 0, linetype = "dashed", 
                  color = "red", linewidth = 0.3) + 
 stat_poly_eq(aes(x = Sample_num, 
                  label = paste(..rr.label.., sep = "~")),
                  formula = y ~ x, parse = TRUE, size = 2) +
  labs(title = "Final vals",
       subtitle = "Hair count vs mass",
       x = "Mass (mg)", y = "Cortisol concentration pg/mg") +
  scale_y_continuous(n.breaks = 10) + 
  theme_minimal() 

```


```{r exp.Final_pg.mg_hair_count2, fig.width=8, fig.height=6}
# Scatter plot of Experiment A and B, observed binding % 
a <- data
a <- filter(data, Person == "Tina", Category == "HairCount", !is.na(Final_pg.mg)) 

a$Sample_num <- 1:length(a$Sample)
cat(paste("Data has", nrow(a), "data points", sep= " "))

remove <- c("F11", "E11", "C11", "D11", "H9", "G9")

a <- a %>%
  filter(!Wells %in% remove)

## PLOT WITHOUT POOR QUALITY SAMPLES ### 

ggplot(a, aes(x = weight_mg, 
                 y = Final_pg.mg)) +
  geom_smooth(method = "lm", se = TRUE, linewidth = 0.4, alpha = 0.2, aes(group = a$Person)) +
  geom_point(size = 2) +
  geom_text(aes(label = Sample), size = 2.5, vjust = -1, hjust = 0.5, color = "gray30") +
  geom_hline(yintercept = 0, linetype = "dashed", 
                  color = "red", linewidth = 0.3) + 
 stat_poly_eq(aes(x = Sample_num, 
                  label = paste(..rr.label.., sep = "~")),
                  formula = y ~ x, parse = TRUE, size = 4) +
  labs(title = "Final vals",
       subtitle = "Hair count vs mass",
       x = "Mass (mg)", y = "Cortisol concentration pg/mg") +
  scale_y_continuous(n.breaks = 10) + 
  theme_minimal() 

ggplot(a, aes(x = Person, y=Final_pg.mg)) +
  geom_boxplot() +
  geom_point()

```


# Comparing all calculation methods
## Summary and boxplots
```{r 4-results-boxplot, echo = FALSE}
# Save result
cat("Results:")
tail(data[,c("Sample", "Final_pg.mg", "Ave_Final_pg.mg")])
data4<-data

# View summary
cat("Summary of final values for each calculation method")
cat("Method A:")
summary(data$Final_pg.mg)
cat("Method B:")
summary(data$Ave_Final_pg.mg)

# Reshape from wide to long format
data_long <- data %>%
  dplyr::select(Final_pg.mg, Ave_Final_pg.mg) %>%
  pivot_longer(
    cols = everything(),
    names_to = "Method",
    values_to = "pg_mg"
  )

# clean group names for x-axis labels
data_long$Group <- gsub("_Final_pg.mg", "", data_long$Method)

# Plot boxplots
ggplot(data_long, aes(x = Group, y = pg_mg, fill = Method)) +
  geom_boxplot(outlier.shape = 21, outlier.fill = "white", outlier.color = "black", width = 0.15, alpha = 0.4) +
  geom_violin(alpha = 0.25) +
  labs(
    title = "Test4: Final values using calculation methods A, B, and C",
    x = "Method",
    y = "pg/mg"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

```




```{r}

a <- filter(data, Person == "Paloma", Category == "HairCount", 
 spike == 0,   !is.na(Final_pg.mg)) 

a <- a %>%
  group_by(Sample) %>%
  mutate(Ave_Conc_pg.ml = (mean(Conc_pg.ml, na.rm = TRUE))) %>%
  mutate(Ave_Final_pg.mg = (mean(Final_pg.mg, na.rm = TRUE))) %>%
  mutate(CV.Perc = (sd(Final_pg.mg, na.rm = TRUE) / mean(Final_pg.mg, na.rm = TRUE)) * 100) %>%
  mutate(z = (Final_pg.mg - mean(Final_pg.mg, na.rm = TRUE)) / sd(Final_pg.mg, na.rm = TRUE)) %>%
  ungroup()

a[,c("Sample", "Wells", "Binding.Perc", "CV.Perc", "Dilution", "Final_pg.mg", "Ave_Final_pg.mg", "z", "weight_mg", "buffer_ml")]
data$Sample
data$weight_mg
```






